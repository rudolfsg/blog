<!doctype html><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font href=/fonts/Satoshi-Variable.woff2 rel=preload type=font/woff2><link href=/style.css rel=stylesheet><link onload="this.onload=null;this.rel='stylesheet';" as=style href=/katex.css rel=preload><noscript><link href=/katex.css rel=stylesheet></noscript><meta content="Static site generator in Rust" name=description><link href=/favicon.ico rel=icon type=image/x-icon><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><title>Static site generator in Rust</title><body><header><svg xmlns=http://www.w3.org/2000/svg><a alt=home href=/> <circle class=logo cx=70 cy=70 r=70 /> </a></svg><h1 class=heading><a href=/> blog </a></h1></header><div class=postmeta><p class=title>Static site generator in Rust<div class=post-tag-and-date><p class=tags><a href=/tags/programming>Programming</a> | <a href=/tags/rust>Rust</a><p class=date>2022-12-27</div></div><hr><div class=content><div><p>To become familiar with Rust I implemented a static site generator as my first project. Below is a set of notes which I would’ve found helpful when I started. Code is available <a href=https://github.com/rudolfsg/blog>here</a>.<h2>Static sites</h2><p>I’ve always liked the simplicity of static websites where all pages are generated ahead of time instead of waiting on a back-end server to generate pages on demand. Static sites are also a perfect fit for content delivery networks (CDN) which enables great performance.<p>Static site generators usually accept a simple text format like markdown as input to generate pages. A simple input format eliminates most of the tool/framework lock-in and substantially increases the probability of your content being usable 10 or 20 years down the line. This is probably why note-taking software like <a href=https://obsidian.md/>Obsidian</a> has become so popular.<p>Writing your own generator seems like a good starter project since it has a well-defined outcome and lies in the Goldilocks zone in terms of size - big enough to expose you to most of the language features and not too big to overwhelm and take months to do. Plus it allows you to include only the site functionality you want and learn a bit about web development along the way.<h2>The plan</h2><p>Write a static site generator from scratch in Rust for a blog that I might use <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>n</mi><mo>≥</mo><mn>1</mn></mrow><annotation encoding=application/x-tex>n \geq 1</annotation></semantics></math></span><span aria-hidden=true class=katex-html><span class=base><span class=strut style=height:.7719em;vertical-align:-0.136em></span><span class="mord mathnormal">n</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≥</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>1</span></span></span></span> times. It should<ol><li>be simple to modify<li>produce a fast, minimal site<li>support code syntax highlighting and <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding=application/x-tex>\LaTeX</annotation></semantics></math></span><span aria-hidden=true class=katex-html><span class=base><span class=strut style=height:.8988em;vertical-align:-0.2155em></span><span class="mord text"><span class="mord textrm">L</span><span class=mspace style=margin-right:-0.36em></span><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.6833em><span style=top:-2.905em><span class=pstrut style=height:2.7em></span><span class=mord><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class=mspace style=margin-right:-0.15em></span><span class="mord text"><span class="mord textrm">T</span><span class=mspace style=margin-right:-0.1667em></span><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.4678em><span style=top:-2.7845em><span class=pstrut style=height:3em></span><span class=mord><span class="mord textrm">E</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2155em><span></span></span></span></span><span class=mspace style=margin-right:-0.125em></span><span class="mord textrm">X</span></span></span></span></span></span> equations</ol><h1>Your own site generator</h1><p>To generate a static site we:<ol><li>Parse markdown files and transform into html with a library like <a href=https://github.com/raphlinus/pulldown-cmark>pulldown-cmark</a><li>Insert them into html templates with a templating library; <a href=https://github.com/Keats/tera>tera</a> is a popular choice<li>Create site index, copy over assets</ol><p>To make the site pretty we add a <code>style.css</code>, a font or two and we’re done with the basics.<h2>Syntax highlighting</h2><p>By default <code>pulldown-cmark</code> detects code blocks, however, it won’t highlight the syntax. Luckily this is simple to adjust: <code>pulldown-cmark</code> outputs <em>events</em> during parsing, one of which is a <a href=https://docs.rs/pulldown-cmark/latest/pulldown_cmark/enum.Tag.html#variant.CodeBlock>code block</a>. Once we hit this event we can override the default behaviour by feeding the code string block into a <a href=https://crates.io/crates/syntect>highlighter</a> and outputting colorised html. We can also set the code block font to <a href=https://www.jetbrains.com/lp/mono/>Jetbrains Mono</a> which looks better and supports ligatures.<p>This gives us nice code snippets:<pre><code class=code-block><span style=color:#cc99cc>pub struct </span><span style=color:#d3d0c8>EventIterator<</span><span style=color:#cc99cc>'a</span><span style=color:#d3d0c8>, I: Iterator&LTItem = Event<</span><span style=color:#cc99cc>'a</span><span style=color:#d3d0c8>>>> {
</span><span style=color:#d3d0c8>    </span><span style=color:#f2777a>parser</span><span style=color:#d3d0c8>: MultiPeek&LTI>,
</span><span style=color:#d3d0c8>    </span><span style=color:#f2777a>has_katex</span><span style=color:#d3d0c8>: </span><span style=color:#cc99cc>bool</span><span style=color:#d3d0c8>,
</span><span style=color:#d3d0c8>    </span><span style=color:#f2777a>image_scale</span><span style=color:#d3d0c8>: HashMap&LTString, </span><span style=color:#cc99cc>f64</span><span style=color:#d3d0c8>>,
</span><span style=color:#d3d0c8>}
</span></code></pre><h2>Images</h2><p><code>pulldown-cmark</code> parses embedded images just fine, but it’s worthwhile to add some extra logic to make the embedding process smoother and improve site performance:<ul><li>By default the image caption won’t be transferred to html even though the caption is captured as a part of the <code>Image</code> event. Like with syntax highlighting we can capture the parsing event and output adjusted html which includes the caption<li>When writing a post I want to paste images from the clipboard and not worry about resizing them manually. So I adjusted the image parser to look for an extra tag after the image: For example, <code>![cool](images/backflip.jpg){width=50%}</code> would resize the image by half which makes life easier and saves a lot of bandwidth<li>To further reduce bandwidth I’ve added conversion of <code>png</code> and <code>jpeg</code> to <code>webp</code></ul><p>Now the above command works:<p><figure><img alt=cool height=251 src=/images/backflip.webp width=378><figcaption>cool</figcaption></figure><h2>Math equations</h2><p>To render math equations we can use <a href=https://katex.org/>katex</a>. But unlike code blocks <code>pulldown-cmark</code> won’t automatically detect or render math due to lack of standardisation <sup class=footnote-reference><a href=#math>1</a></sup>, so we have to roll our own.<p>To delineate math blocks in markdown I use single dollar signs for inline math <code>$ x^2 $</code> and double for <em>display mode</em> math <code>$$ x^2 $$</code>. We can then detect math blocks by checking each paragraph for <code>$</code>.<p>To render the equations we could leave the math blocks alone and include <code>katex</code> auto-render javascript in our site. But in the spirit of static generation, we can render the equations ahead of time with <a href=https://docs.rs/katex/latest/katex/>katex rust bindings</a> and include the necessary fonts/css in our site instead of going to their CDN.<p>And now we can do this:<p><span class=katex-display><span class=katex><span class=katex-mathml><math display=block xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msubsup><mo>∫</mo><mrow><mo>−</mo><mi mathvariant=normal>∞</mi></mrow><mi mathvariant=normal>∞</mi></msubsup><msup><mi>e</mi><mrow><mo>−</mo><msup><mi>x</mi><mn>2</mn></msup></mrow></msup><mi>d</mi><mi>x</mi><mo>=</mo><msqrt><mi>π</mi></msqrt></mrow><annotation encoding=application/x-tex> \int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi} </annotation></semantics></math></span><span aria-hidden=true class=katex-html><span class=base><span class=strut style=height:2.3846em;vertical-align:-0.9703em></span><span class=mop><span class="mop op-symbol large-op" style=margin-right:.44445em;position:relative;top:-0.0011em>∫</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.4143em><span style=top:-1.7881em;margin-left:-0.4445em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style=top:-3.8129em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∞</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.9703em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">e</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:1.0369em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-2.931em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.04em;vertical-align:-0.1908em></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8492em><span class=svg-align style=top:-3em><span class=pstrut style=height:3em></span><span class=mord style=padding-left:.833em><span class="mord mathnormal" style=margin-right:.03588em>π</span></span></span><span style=top:-2.8092em><span class=pstrut style=height:3em></span><span class=hide-tail style=min-width:.853em;height:1.08em><svg preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" height=1.08em width=400em xmlns=http://www.w3.org/2000/svg><path d="M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1908em><span></span></span></span></span></span></span></span></span></span><h2>Other things</h2><p>Self-hosting your assets like fonts and icons <a href=https://www.tunetheweb.com/blog/should-you-self-host-google-fonts/>may improve performance</a> since it avoids going to a third-party CDN. Besides, having a fully self-contained site is nice.<p>Modern font formats like WOFF2 take less space and nowadays have <a href=https://caniuse.com/woff2>good support</a> making them an easy choice. Font size can be further improved via subsetting. <sup class=footnote-reference><a href=#font>2</a></sup> Using a variable font keeps the codebase cleaner as you don’t have to store separate files for italic, bold, regular etc. <a href=https://www.fontshare.com/>Fontshare</a> is a good resource.<h1>End result</h1><p>Overall I’m glad I chose this as a starter project and I’m left quite impressed with the quality of Rust tooling and documentation. Performance isn’t bad either - generating this site took 145ms on AMD Ryzen 5600x and Google PageSpeed seems happy too!<p><figure><img alt="pagespeed.web.dev score" height=717 src=/images/pagespeed.webp width=956><figcaption>pagespeed.web.dev score</figcaption></figure><h3>Footnotes</h3><hr><div class=footnote-definition id=math><sup class=footnote-definition-label>1</sup><p>While Markdown is not a proper specification, CommonMark is but the <a href=https://spec.commonmark.org/>spec</a> doesn’t mention math once. Unfortunately, the popular <code>$</code> delimiter allow for ambiguities which is a no-no for a spec.</div><p>For <code>pulldown-cmark</code> there’s lots of <a href=https://github.com/raphlinus/pulldown-cmark/issues/6>discussion on the issue</a> going back to 2015 (!). However, there’s good progress on <a href=https://github.com/raphlinus/pulldown-cmark/pull/622>an extension</a>.<div class=footnote-definition id=font><sup class=footnote-definition-label>2</sup><p>This <a href=https://markoskon.com/creating-font-subsets/>article on subsetting</a> is great. However, there don’t seem to be great rust libraries to do it seamlessly and it might break things if you’re not careful, all to save what is likely less than ~50kb.</div></div></div><footer><h1 class=about><a href=/about> about </a></h1></footer>